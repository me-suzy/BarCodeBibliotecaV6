# **Cum funcÈ›ioneazÄƒ scanare_monitor_principal.php - EXPLICAÈšIE COMPLETÄ‚**

---

## **ğŸ“‹ FLUXUL COMPLET PAS CU PAS:**

### **PASUL 1: Scanezi CARNETUL cititorului (USER***)**

```
ğŸ‘‰ Scanezi USER001
    â†“
Scanner trimite: U â†’ S â†’ E â†’ R â†’ 0 â†’ 0 â†’ 1 â†’ ENTER
    â†“
Formularul HTML se trimite automat la server (POST)
    â†“
PHP primeÈ™te: cod_scanat = "USER001"
```

**Ce face PHP:**

1. **VerificÄƒ dacÄƒ e format USER**:
   ```php
   preg_match('/^USER\d+$/i', $cod_scanat) // TRUE
   ```

2. **CautÄƒ Ã®n baza de date:**
   ```sql
   SELECT * FROM cititori WHERE cod_bare = 'USER001'
   ```

3. **DacÄƒ gÄƒseÈ™te cititorul:**
   - **SalveazÄƒ Ã®n sesiune** (ca sÄƒ-l È›inÄƒ minte 2 minute):
     ```php
     $_SESSION['cititor_activ'] = [
         'cod_bare' => 'USER001',
         'nume' => 'Radu',
         'prenume' => 'Mihai',
         'telefon' => '0721123456',
         'email' => 'radu@email.com'
     ];
     ```
   
   - **ÃnregistreazÄƒ prezenÈ›a** (cÄƒ a venit la bibliotecÄƒ):
     ```sql
     INSERT INTO sesiuni_biblioteca (cod_cititor, data, ora_intrare)
     VALUES ('USER001', '2025-11-16', '14:30:00')
     ```

4. **AfiÈ™eazÄƒ mesaj:**
   ```
   âœ… Bine ai venit, Mihai Radu!
   ```

5. **AfiÈ™eazÄƒ caseta verde** cu:
   - ğŸ‘¤ Nume: Radu Mihai
   - ğŸ†” Cod: USER001
   - ğŸ“ Telefon: 0721123456
   - ğŸ“§ Email: radu@email.com
   - â±ï¸ Timer: 2:00 (countdown)

---

### **PASUL 2: Scanezi CARTEA (BOOK***)**

```
ğŸ‘‰ Scanezi BOOK003
    â†“
Scanner trimite: B â†’ O â†’ O â†’ K â†’ 0 â†’ 0 â†’ 3 â†’ ENTER
    â†“
Formularul HTML se trimite la server (POST)
    â†“
PHP primeÈ™te: cod_scanat = "BOOK003"
```

**Ce face PHP:**

1. **VerificÄƒ dacÄƒ e format BOOK**:
   ```php
   preg_match('/^BOOK\d+$/i', $cod_scanat) // TRUE
   ```

2. **VerificÄƒ dacÄƒ existÄƒ cititor activ**:
   ```php
   if (!isset($_SESSION['cititor_activ'])) {
       // EROARE: "âš ï¸ ScaneazÄƒ carnetul!"
   }
   ```

3. **DacÄƒ existÄƒ cititor, cautÄƒ cartea:**
   ```sql
   SELECT * FROM carti WHERE cod_bare = 'BOOK003'
   ```
   
   **Rezultat:** 
   - Titlu: "Groapa"
   - Autor: "Eugen Barbu"
   - ISBN: "9789734640560"
   - LocaÈ›ie: "Raft A - Nivel 2 - PoziÈ›ia 05"

4. **VerificÄƒ dacÄƒ cartea e deja Ã®mprumutatÄƒ:**
   ```sql
   SELECT i.*, c.nume, c.prenume 
   FROM imprumuturi i
   JOIN cititori c ON i.cod_cititor = c.cod_bare
   WHERE i.cod_carte = 'BOOK003' AND i.status = 'activ'
   ```

---

### **SITUAÈšIA A: Cartea NU e Ã®mprumutatÄƒ â†’ ÃMPRUMUT NOU**

```
Cartea e liberÄƒ
    â†“
PHP salveazÄƒ Ã®mprumutul Ã®n BD:
    INSERT INTO imprumuturi (cod_cititor, cod_carte, status) 
    VALUES ('USER001', 'BOOK003', 'activ')
    â†“
PHP trimite EMAIL automat:
    require_once 'notificare_imprumut.php';
    trimite_email_imprumut($pdo, 'USER001', 'BOOK003');
    â†“
Email trimis la: radu@email.com
    Subiect: "ğŸ“š Confirmare Ãmprumut Carte"
    ConÈ›inut: Detalii carte + Data returnare (peste 14 zile)
    â†“
PHP salveazÄƒ Ã®n log:
    INSERT INTO notificari (cod_cititor, tip_notificare, canal, destinatar, status)
    VALUES ('USER001', 'imprumut', 'email', 'radu@email.com', 'trimis')
```

**AfiÈ™eazÄƒ mesaj:**
```
âœ… Ãmprumut Ã®nregistrat cu succes!
ğŸ“• Groapa
Returnare recomandatÄƒ: 30.11.2025
ğŸ“§ Email de confirmare trimis
```

**AfiÈ™eazÄƒ preview carte:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“• Detalii Carte ScanatÄƒ        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Titlu:     Groapa               â”‚
â”‚ Autor:     Eugen Barbu          â”‚
â”‚ ISBN:      9789734640560        â”‚
â”‚ LocaÈ›ie:   Raft A - Nivel 2 - 05â”‚
â”‚ SecÈ›iune:  LiteraturÄƒ romÃ¢nÄƒ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ActualizeazÄƒ statistici:**
- Ãmprumuturi Active: 9 â†’ **10**
- Ãmprumuturi Azi: 10 â†’ **11**

**AdaugÄƒ Ã®n "Activitate RecentÄƒ":**
```
Radu Mihai
Groapa
ğŸ“¤ Ãmprumut
```

---

### **SITUAÈšIA B: Cartea E Ã®mprumutatÄƒ de ACELAÈ˜I cititor â†’ RETURNARE**

```
Cartea e Ã®mprumutatÄƒ de USER001 (acelaÈ™i care a scanat)
    â†“
PHP actualizeazÄƒ Ã®n BD:
    UPDATE imprumuturi
    SET status = 'returnat', data_returnare = NOW()
    WHERE cod_carte = 'BOOK003' AND cod_cititor = 'USER001' AND status = 'activ'
```

**AfiÈ™eazÄƒ mesaj:**
```
ğŸ“¥ Carte returnatÄƒ cu succes!
Groapa
```

**ActualizeazÄƒ statistici:**
- Ãmprumuturi Active: 9 â†’ **8**
- ReturnÄƒri Azi: 1 â†’ **2**

**AdaugÄƒ Ã®n "Activitate RecentÄƒ":**
```
Radu Mihai
Groapa
ğŸ“¥ Returnare
```

---

### **SITUAÈšIA C: Cartea e Ã®mprumutatÄƒ de ALTCINEVA â†’ EROARE**

```
Cartea e Ã®mprumutatÄƒ de USER005 (Ionescu Maria)
    â†“
PHP NU face nimic Ã®n BD
```

**AfiÈ™eazÄƒ mesaj:**
```
âŒ Cartea este Ã®mprumutatÄƒ de: Ionescu Maria
```

---

## **â±ï¸ TIMEOUT AUTOMAT (2 minute)**

```javascript
// JavaScript numÄƒrÄƒ countdown
secundeRamase = 120; // 2:00

setInterval(function() {
    secundeRamase--;
    
    if (secundeRamase <= 0) {
        window.location.reload(); // ReÃ®ncarcÄƒ pagina
        // Sesiunea PHP se È™terge automat
    }
    
    // AfiÈ™eazÄƒ: â±ï¸ 1:59, 1:58, 1:57...
}, 1000);
```

**CÃ¢nd expirÄƒ (0:00):**
1. Pagina se reÃ®ncarcÄƒ automat
2. PHP È™terge sesiunea:
   ```php
   unset($_SESSION['cititor_activ']);
   ```
3. Revine la starea iniÈ›ialÄƒ: "âš ï¸ Pas 1: ScaneazÄƒ carnetul"

---

## **ğŸ”„ BUTONUL RESET**

```
Click pe "âŒ RESET"
    â†“
Browser deschide: scanare_monitor_principal.php?reset=1
    â†“
PHP detecteazÄƒ: isset($_GET['reset'])
    â†“
PHP È™terge sesiunea: unset($_SESSION['cititor_activ'])
    â†“
Redirect la: scanare_monitor_principal.php
    â†“
PaginÄƒ curatÄƒ, fÄƒrÄƒ cititor activ
```

---

## **ğŸ“Š STATISTICILE (se actualizeazÄƒ la fiecare refresh)**

```php
// La fiecare Ã®ncÄƒrcare paginÄƒ, PHP contorizeazÄƒ:
$stats = [
    'total_carti' => COUNT(*) FROM carti,
    'total_cititori' => COUNT(*) FROM cititori,
    'imprumuturi_active' => COUNT(*) FROM imprumuturi WHERE status='activ',
    'imprumuturi_azi' => COUNT(*) FROM imprumuturi WHERE DATE(data_imprumut)=TODAY,
    'returnari_azi' => COUNT(*) FROM imprumuturi WHERE DATE(data_returnare)=TODAY,
    'vizitatori_azi' => COUNT(DISTINCT cod_cititor) FROM sesiuni_biblioteca WHERE data=TODAY,
    'intarzieri' => COUNT(*) FROM imprumuturi WHERE status='activ' AND zile>14
];
```

---

## **ğŸ“œ ISTORICUL CITITORULUI (dacÄƒ existÄƒ cititor activ)**

```php
// PHP ia ultimele 10 Ã®mprumuturi ale cititorului activ:
SELECT c.titlu, c.autor, i.data_imprumut, i.status
FROM imprumuturi i
JOIN carti c ON i.cod_carte = c.cod_bare
WHERE i.cod_cititor = 'USER001'
ORDER BY i.data_imprumut DESC
LIMIT 10
```

**AfiÈ™eazÄƒ:**
```
ğŸ“š Istoric Ãmprumuturi Cititor
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Groapa - Eugen Barbu       â”‚
â”‚ ğŸ“¤ Activ - 3 zile          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Maitreyi - Mircea Eliade   â”‚
â”‚ ğŸ“¥ Returnat - 12 zile      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## **ğŸ¯ REZUMAT FLUX:**

```
1. Scanner â†’ Browser â†’ POST â†’ PHP
2. PHP verificÄƒ tip cod (USER/BOOK)
3. PHP cautÄƒ Ã®n MySQL
4. PHP decide: Ãmprumut / Returnare / Eroare
5. PHP salveazÄƒ Ã®n BD
6. PHP trimite email (dacÄƒ Ã®mprumut nou)
7. PHP genereazÄƒ HTML nou
8. Browser afiÈ™eazÄƒ rezultatul
9. JavaScript auto-focus pe input
10. Timeout 2 minute â†’ reset automat
```

---

**Asta e tot! Simplu È™i clar!** ğŸ¯âœ¨

Ai Ã®ntrebÄƒri despre vreun pas specific?